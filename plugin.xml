<?xml version="1.0" encoding="UTF-8"?>
<plugin xmlns="http://apache.org/cordova/ns/plugins/1.0"
    id="cordova-plugin-change-app-info"
    version="2.9.10">
    
    <name>Change App Info (iOS Optimized)</name>
    <description>Cordova plugin to change app package name, display name, version and icon from CDN at build time. Creates read-only SQLite database with build info. Supports splash screen and webview background color customization. Optimized for OutSystems MABS.</description>
    <license>MIT</license>
    <keywords>cordova,app,info,package,displayname,version,icon,ios,android,cdn,optimized,sqlite,build-info,outsystems</keywords>
    
    <author>vnkhoado</author>
    <repo>https://github.com/vnkhoado/cordova-plugin-change-app-info.git</repo>
    
    <engines>
        <engine name="cordova" version=">=9.0.0" />
    </engines>
    
    <!-- ============================================================================
         DEPENDENCIES
         ============================================================================
    
    Required:
    - better-sqlite3: Node.js library for build-time database generation
      (NOT the same as cordova-sqlite-storage which is for runtime app access)
    
    Optional:
    - sharp: Fast image resizing for CDN icon generation (recommended)
    - jimp: Fallback image processor (pure JS, slower)
    - cordova-sqlite-storage: Runtime SQLite access for app (optional)
    
    ============================================================================ -->
    
    <!-- Better SQLite3: REQUIRED for build info database generation -->
    <!-- This is a Node.js library for the build process, not a Cordova plugin -->
    <!-- Install with: npm install better-sqlite3 -->
    <!-- Or auto-install with: npm run setup -->
    
    <!-- Optional: SQLite Runtime Access -->
    <!-- Only needed if your app needs to write to the database at runtime -->
    <!-- <dependency id="cordova-sqlite-storage" version="^6.1.0" /> -->
    
    <!-- ============================================================================
         CONFIGURATION PREFERENCES
         ============================================================================
    
    App Configuration:
    - APP_NAME: App display name (e.g., "MyApp")
    - VERSION_NUMBER: Version string (e.g., "1.0.0")
    - VERSION_CODE: Build number (e.g., "1")
    - CDN_ICON: Icon URL (e.g., https://cdn.com/icon-1024.png)
    
    Splash Screen:
    - SplashScreenBackgroundColor: Solid color (e.g., "#001833")
    - SPLASH_GRADIENT: CSS gradient for native splash (e.g., "linear-gradient(135deg, #667eea 0%, #764ba2 100%)")
    
    Runtime Configuration:
    - API_HOSTNAME: API hostname (e.g., "api.myapp.com")
    - ENVIRONMENT: Environment name (e.g., "production")
    
    UI Customization:
    - WEBVIEW_BACKGROUND_COLOR: Webview background (e.g., "#001833")
    
    Build Notification (Optional):
    - ENABLE_BUILD_NOTIFICATION: "true" or "false"
    - BUILD_SUCCESS_API_URL: Notification endpoint
    - BUILD_API_BEARER_TOKEN: Bearer token
    
    ============================================================================ -->
    
    <!-- Android Platform -->
    <platform name="android">
        <!-- Auto-install dependencies before build -->
        <hook type="before_prepare" src="scripts/auto-install-deps.js" />
        
        <!-- Standard build hooks -->
        <hook type="before_prepare" src="hooks/backupAppInfo.js" />
        <hook type="after_prepare" src="hooks/changeAppInfo.js" />
        <hook type="after_prepare" src="hooks/generateIcons.js" />
        <hook type="after_prepare" src="hooks/injectBuildInfo.js" />
        <hook type="after_prepare" src="hooks/customizeSplashScreen.js" />
        <hook type="after_prepare" src="hooks/customizeWebview.js" />
        <hook type="before_compile" src="hooks/forceOverrideSplashColor.js" />
        <hook type="before_compile" src="hooks/forceOverrideNativeColors.js" />
        <hook type="before_compile" src="hooks/scanAndReplaceColor.js" />
        <hook type="post_compile" src="hooks/forceMBASSplashColor.js" />
        <hook type="after_build" src="hooks/sendBuildSuccess.js" />
    </platform>
    
    <!-- iOS Platform - OPTIMIZED: Full hook chain for gradient native splash -->
    <platform name="ios">
        <!-- Auto-install dependencies before build -->
        <hook type="before_prepare" src="scripts/auto-install-deps.js" />
        
        <!-- IMPORTANT: Clear old cache to ensure app name/icon updates are visible -->
        <!-- This hook automatically clears Xcode cache and metadata before building -->
        <!-- Prevents issue where app name/icon show old values after rebuild -->
        <hook type="before_prepare" src="hooks/ios-cache-clear.js" />
        
        <!-- iOS-optimized hooks -->
        <hook type="after_prepare" src="hooks/ios/unified-prepare-standalone.js" />
        
        <!-- NEW: Inject gradient splash into HTML (for after webview loads) -->
        <!-- Use SPLASH_GRADIENT preference in config.xml for CSS gradient -->
        <hook type="after_prepare" src="hooks/ios/inject-gradient-splash.js" />
        
        <!-- CRITICAL: Force override MABS metadata with plugin values -->
        <!-- Solves MABS sending old app name "My One Mount" + old icon -->
        <!-- Completely replaces MABS metadata with config.xml values -->
        <!-- Prevents flickering or old values showing -->
        <hook type="before_compile" src="hooks/ios/force-metadata-override.js" />
        
        <!-- NEW: Generate native gradient splash image from CSS gradient -->
        <!-- Converts SPLASH_GRADIENT CSS to actual PNG image -->
        <!-- Displays gradient at app launch (real native splash) -->
        <hook type="before_compile" src="hooks/ios/native-gradient-splash.js" />
        
        <hook type="before_compile" src="hooks/ios/unified-compile.js" />
        <hook type="post_compile" src="hooks/forceMBASSplashColor.js" />
        <hook type="before_build" src="hooks/ios/unified-build.js" />
        <hook type="after_build" src="hooks/sendBuildSuccess.js" />
        
        <!-- iOS Configuration -->
        <config-file target="*-Info.plist" parent="CFBundleIconName">
            <string>AppIcon</string>
        </config-file>
    </platform>
</plugin>
