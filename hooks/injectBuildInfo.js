#!/usr/bin/env node

const fs = require("fs");
const path = require("path");
const { getConfigParser } = require("./utils");

/**
 * Táº¡o file JavaScript chá»©a build info vá»›i merge logic
 */
function createBuildInfoJS(buildInfo) {
  return `
// Auto-generated by cordova-plugin-change-app-info
// Build Time: ${buildInfo.buildTime}

(function() {
  'use strict';
  
  var newBuildInfo = ${JSON.stringify(buildInfo, null, 2)};
  
  // Wait for deviceready
  document.addEventListener('deviceready', function() {
    try {
      // Äá»c dá»¯ liá»‡u cÅ© tá»« localStorage
      var existingDataStr = localStorage.getItem('APP_BUILD_INFO');
      var existingData = existingDataStr ? JSON.parse(existingDataStr) : {};
      
      // Preserve cÃ¡c field quan trá»ng tá»« data cÅ©
      var preservedData = {
        firstInstallTime: existingData.firstInstallTime || newBuildInfo.buildTime,
        firstInstallVersion: existingData.firstInstallVersion || newBuildInfo.versionNumber,
        installCount: (existingData.installCount || 0) + 1,
        
        // User data (náº¿u cÃ³)
        userData: existingData.userData || {},
        userSettings: existingData.userSettings || {},
        lastActiveTime: existingData.lastActiveTime || null
      };
      
      // Detect update
      var isUpdate = existingData.versionNumber && 
                     existingData.versionNumber !== newBuildInfo.versionNumber;
      
      if (isUpdate) {
        preservedData.lastUpdateTime = new Date().toISOString();
        preservedData.previousVersion = existingData.versionNumber;
        preservedData.previousVersionCode = existingData.versionCode;
        console.log('[Build Info] Update detected:', existingData.versionNumber, 'â†’', newBuildInfo.versionNumber);
      }
      
      // Merge: Build info má»›i + Preserved data
      var mergedBuildInfo = Object.assign({}, newBuildInfo, preservedData);
      
      // LÆ°u láº¡i
      localStorage.setItem('APP_BUILD_INFO', JSON.stringify(mergedBuildInfo));
      
      // Set global variable
      window.APP_BUILD_INFO = mergedBuildInfo;
      
      console.log('[Build Info] Loaded and merged:', mergedBuildInfo);
      console.log('[Build Info] API Hostname:', mergedBuildInfo.apiHostname);
      console.log('[Build Info] First install:', preservedData.firstInstallVersion, 'at', preservedData.firstInstallTime);
      console.log('[Build Info] Install count:', preservedData.installCount);
      
    } catch (e) {
      console.error('[Build Info] Failed to save:', e);
    }
  }, false);
  
  // Helper function to update user data without losing build info
  window.updateAppUserData = function(key, value) {
    try {
      var buildInfo = JSON.parse(localStorage.getItem('APP_BUILD_INFO') || '{}');
      if (!buildInfo.userData) {
        buildInfo.userData = {};
      }
      buildInfo.userData[key] = value;
      buildInfo.lastActiveTime = new Date().toISOString();
      localStorage.setItem('APP_BUILD_INFO', JSON.stringify(buildInfo));
      window.APP_BUILD_INFO = buildInfo;
      console.log('[Build Info] User data updated:', key);
    } catch (e) {
      console.error('[Build Info] Failed to update user data:', e);
    }
  };
  
  // Helper function to update user settings
  window.updateAppSettings = function(settings) {
    try {
      var buildInfo = JSON.parse(localStorage.getItem('APP_BUILD_INFO') || '{}');
      buildInfo.userSettings = Object.assign(buildInfo.userSettings || {}, settings);
      buildInfo.lastActiveTime = new Date().toISOString();
      localStorage.setItem('APP_BUILD_INFO', JSON.stringify(buildInfo));
      window.APP_BUILD_INFO = buildInfo;
      console.log('[Build Info] Settings updated');
    } catch (e) {
      console.error('[Build Info] Failed to update settings:', e);
    }
  };
  
})();
`;
}

/**
 * Inject build info vÃ o www folder
 */
function injectBuildInfo(context, platform) {
  const root = context.opts.projectRoot;
  
  // Äá»c config
  const config = getConfigParser(context, path.join(root, "config.xml"));
  
  // Äá»c hostname tá»« config
  const apiHostname = config.getPreference("API_HOSTNAME") || "";
  const apiBaseUrl = config.getPreference("API_BASE_URL") || "";
  const environment = config.getPreference("ENVIRONMENT") || "production";
  
  const buildInfo = {
    // Build info (sáº½ Ä‘Æ°á»£c update má»—i build)
    appName: config.getPreference("APP_NAME") || config.name() || "Unknown",
    versionNumber: config.getPreference("VERSION_NUMBER") || config.version() || "0.0.0",
    versionCode: config.getPreference("VERSION_CODE") || "0",
    packageName: config.packageName() || "unknown",
    platform: platform,
    buildTime: new Date().toISOString(),
    buildTimestamp: Date.now(),
    
    // API Configuration (cÃ³ thá»ƒ thay Ä‘á»•i theo environment)
    apiHostname: apiHostname,
    apiBaseUrl: apiBaseUrl,
    environment: environment,
    
    // CDN Info (optional)
    cdnIcon: config.getPreference("CDN_ICON") || null
    
    // firstInstallTime, firstInstallVersion, userData, userSettings
    // sáº½ Ä‘Æ°á»£c preserve tá»« localStorage cÅ©
  };
  
  // ÄÆ°á»ng dáº«n www cá»§a platform
  let wwwPath;
  if (platform === "android") {
    wwwPath = path.join(root, "platforms/android/app/src/main/assets/www");
  } else if (platform === "ios") {
    wwwPath = path.join(root, "platforms/ios/www");
  } else {
    console.log(`âš ï¸ Platform ${platform} not supported for build info injection`);
    return;
  }
  
  if (!fs.existsSync(wwwPath)) {
    console.log(`âš ï¸ WWW path not found: ${wwwPath}`);
    return;
  }
  
  // Táº¡o file build-info.js
  const buildInfoPath = path.join(wwwPath, "build-info.js");
  const jsContent = createBuildInfoJS(buildInfo);
  
  fs.writeFileSync(buildInfoPath, jsContent, "utf8");
  console.log(`âœ… Build info injected to: ${buildInfoPath}`);
  console.log(`   App: ${buildInfo.appName} v${buildInfo.versionNumber} (${buildInfo.versionCode})`);
  console.log(`   Environment: ${buildInfo.environment}`);
  console.log(`   API Hostname: ${buildInfo.apiHostname || 'Not configured'}`);
  console.log(`   API Base URL: ${buildInfo.apiBaseUrl || 'Not configured'}`);
  console.log(`   Build: ${buildInfo.buildTime}`);
  console.log(`   Note: User data and install history will be preserved`);
  
  // ThÃªm script tag vÃ o index.html
  injectScriptTag(wwwPath, "build-info.js");
}

/**
 * ThÃªm <script> tag vÃ o index.html
 */
function injectScriptTag(wwwPath, scriptFile) {
  const indexPath = path.join(wwwPath, "index.html");
  
  if (!fs.existsSync(indexPath)) {
    console.log("âš ï¸ index.html not found");
    return;
  }
  
  let html = fs.readFileSync(indexPath, "utf8");
  
  // Check xem Ä‘Ã£ cÃ³ script tag chÆ°a
  if (html.includes(scriptFile)) {
    console.log("   Script tag already exists in index.html");
    return;
  }
  
  // ThÃªm script tag trÆ°á»›c </head> hoáº·c trÆ°á»›c cordova.js
  const scriptTag = `    <script src="${scriptFile}"></script>`;
  
  // Æ¯u tiÃªn thÃªm trÆ°á»›c cordova.js
  if (html.includes('cordova.js')) {
    html = html.replace(
      /<script[^>]*src=["']cordova\.js["'][^>]*><\/script>/,
      `${scriptTag}\n    $&`
    );
  } else if (html.includes("</head>")) {
    html = html.replace("</head>", `${scriptTag}\n  </head>`);
  } else if (html.includes("</body>")) {
    html = html.replace("</body>", `${scriptTag}\n  </body>`);
  } else {
    console.log("âš ï¸ Could not find suitable location in index.html");
    return;
  }
  
  fs.writeFileSync(indexPath, html, "utf8");
  console.log(`   Added <script> tag to index.html`);
}

/**
 * Hook chÃ­nh
 */
module.exports = function(context) {
  const platforms = context.opts.platforms;
  
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("     INJECT BUILD INFO HOOK       ");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  
  for (const platform of platforms) {
    console.log(`\nğŸ“± Processing ${platform}...`);
    injectBuildInfo(context, platform);
  }
  
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("âœ… Build info injection completed!");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
};