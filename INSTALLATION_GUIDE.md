# Installation Guide - Fix iOS Build Errors

## Problem

When installing this plugin via Cordova/MABS, you might encounter:

```
CordovaError: Error: Command failed with exit code 1: 
npm install https://github.com/vnkhoado/cordova-plugin-change-app-info.git --save-exact
```

This error occurs because:
1. Plugin requires `better-sqlite3` which is NOT automatically installed
2. npm doesn't resolve optional dependencies correctly in cloud environments (MABS)
3. The auto-install hook may not trigger during remote builds

## Solution

### For Local Development

```bash
# 1. Install dependencies first
npm install better-sqlite3 sharp jimp

# 2. Add plugin
cordova plugin add https://github.com/vnkhoado/cordova-plugin-change-app-info.git

# 3. Build
cordova prepare ios
cordova build ios
```

### For MABS/OutSystems Cloud Build

#### Step 1: Create `package.json` at Project Root

Create file at same level as `config.xml`:

```json
{
  "name": "cordova-app-with-plugin",
  "version": "1.0.0",
  "description": "Cordova app with change-app-info plugin",
  "main": "index.js",
  "scripts": {
    "setup": "npm install",
    "build:ios": "cordova build ios"
  },
  "keywords": ["cordova", "app"],
  "author": "",
  "license": "MIT",
  "dependencies": {
    "better-sqlite3": "^9.0.0",
    "sharp": "^0.33.0",
    "jimp": "^0.22.0"
  },
  "engines": {
    "node": ">=14.0.0",
    "npm": ">=6.0.0"
  }
}
```

#### Step 2: Update `config.xml`

Add plugin with local reference:

```xml
<?xml version='1.0' encoding='utf-8'?>
<widget id="com.example.app" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">
    
    <name>Your App Name</name>
    <description>Your App Description</description>
    
    <!-- Pre-install dependencies hook -->
    <hook type="before_prepare" src="plugins/cordova-plugin-change-app-info/scripts/auto-install-deps.js" />
    
    <!-- Plugin from local folder -->
    <plugin name="cordova-plugin-change-app-info" spec="plugins/cordova-plugin-change-app-info" />
    
    <!-- Required preferences -->
    <preference name="APP_NAME" value="Your App Name" />
    <preference name="VERSION_NUMBER" value="1.0.0" />
    <preference name="VERSION_CODE" value="1" />
    <preference name="CDN_ICON" value="https://cdn.example.com/icon-1024.png" />
    <preference name="SplashScreenBackgroundColor" value="#001833" />
    
    <platform name="ios"></platform>
    <platform name="android"></platform>
    
</widget>
```

#### Step 3: Clone Plugin Locally

```bash
mkdir -p plugins
cd plugins
git clone https://github.com/vnkhoado/cordova-plugin-change-app-info.git
cd ..
```

#### Step 4: Commit to Git

```bash
git add package.json config.xml plugins/
git commit -m "Setup: add dependencies and plugin configuration"
git push origin main
```

#### Step 5: In MABS Console

1. Go to OutSystems MABS
2. Ensure app source points to your Git repo
3. Trigger a new build
4. Build should now succeed ✅

## File Structure

After following the above steps:

```
your-cordova-project/
├── config.xml
├── package.json              ← NEW
├── package-lock.json         ← Generated by npm
├── plugins/
│   ├── cordova-plugin-change-app-info/  ← LOCAL PLUGIN
│   │   ├── plugin.xml
│   │   ├── package.json
│   │   ├── scripts/
│   │   ├── hooks/
│   │   └── src/
│   └── fetch.json
├── node_modules/             ← Generated by npm install
│   ├── better-sqlite3/
│   ├── sharp/
│   └── jimp/
├── www/
└── platforms/
```

## Verify Installation

```bash
# Check if plugin is installed
cordova plugin list
# Expected output:
# cordova-plugin-change-app-info 2.9.10 "Change App Info (iOS Optimized)"

# Check if dependencies are installed
npm list
# Expected output:
# ├── better-sqlite3@9.x.x
# ├── sharp@0.33.x
# └── jimp@0.22.x
```

## Troubleshooting

### Issue: `better-sqlite3` installation fails

**Solution 1:** Use Python 3.x
```bash
npm install --build-from-source better-sqlite3
```

**Solution 2:** Skip better-sqlite3 and use jimp
```bash
npm install jimp
```

### Issue: Plugin not found during build

```bash
# Remove old plugin
cordova plugin remove cordova-plugin-change-app-info

# Re-add from local folder
cordova plugin add plugins/cordova-plugin-change-app-info
```

### Issue: NPM registry timeout

```bash
# Increase npm timeout
npm config set fetch-timeout 120000
npm config set fetch-retry-mintimeout 20000
npm config set fetch-retry-maxtimeout 120000

# Then retry
npm install
```

### Issue: MABS build still fails

1. Clear build cache in MABS console
2. Force rebuild with `--no-cache`
3. Check that `package.json` is committed to Git
4. Verify all files are pushed to repository

## Additional Resources

- [CDN Assets Guide](./CDN_ASSETS_GUIDE.md)
- [iOS Build Fix](./IOS_BUILD_FIX.md)
- [iOS Icon Debug](./IOS_ICON_DEBUG.md)
- [OutSystems Fix](./OUTSYSTEMS_FIX.md)

## Questions?

If you encounter issues not covered here:
1. Check existing GitHub issues
2. Create a new issue with:
   - Error message
   - Node version (`node --version`)
   - NPM version (`npm --version`)
   - Cordova version (`cordova --version`)
   - OS (macOS/Linux/Windows)
